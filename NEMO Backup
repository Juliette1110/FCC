# -*- coding: utf-8 -*-
"""Nemo backup.ipynb
f
Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1mft39TK2HzgjBw7Nakf2ylrZcPBb13PE
"""

import imaplib
ORG_EMAIL   = "@nd.edu"
FROM_EMAIL  = "jburcham" + ORG_EMAIL
FROM_PWD    = password = input("please enter password:") #logging on
SMTP_SERVER = "imap.gmail.com" #import gmail
SMTP_PORT   = 993
 #establish cennection to email server
mail = imaplib.IMAP4_SSL(SMTP_SERVER)
mail.login(FROM_EMAIL,FROM_PWD)

"""The next task is to download all of the emails and split the subject and message text into 'topic' using Gensium. This is known as topic modeling. So download the messages/subjects:"""

import email



mail.select('inbox')
#now fetch email ids
type, data = mail.search(None, 'ALL')
mail_ids = data[0]
id_list = mail_ids.split()
#fetch subject and headers
first_email_id = int(id_list[0])
latest_email_id = int(id_list[-1])
print(first_email_id)

!pip install ipdb

typ, data = mail.fetch('1', '(RFC822)' )


import ipdb as pdb
hat=[]
for i in range(latest_email_id,first_email_id, -1):
            typ, data = mail.fetch(str(i), '(RFC822)' )
    
            

            for response_part in data:
                if isinstance(response_part, tuple):
                    #pdb.set_trace()
                    msg = email.message_from_string(response_part[1].decode("utf-8",'ignore') )
                    #email_subject = msg['subject']
                    #email_from = msg['from']
                   # print ('From : ' + email_from + '\n')
                    #print ('Subject : ' + email_subject + '\n')
                    #for part in msg.get_payload():
                    for part in msg.walk():
                      if part.get_content_type() == 'text/plain':
                        #print (part.get_payload())
                        hat.append(part.get_payload())
                      
                      #print(msg.get_payload())
                      #hat=msg.get_payload()

tree=" ".join(hat)
test=tree

#import re
#test=re.findall(r"[\w']+|[.,!?;]", "Get frustrated with double-digit temperature swings? Still upset about those -40 degree days back in January? Concerned about the extent of damage society's use of fossil fuels has caused to the environment and its potential implications for humanity's continued survival on planet earth???")
#test= "Get frustrated with double-digit temperature swings? Still upset about those -40 degree days back in January? Concerned about the extent of damage society's use of fossil fuels has caused to the environment and its potential implications for humanity's continued survival on planet earth???"
#test= "time with his long stride, they walked back through the night to the farm. He had taken to the girl from the first day, when he had driven over to the Flats to meet her, and she had smiled and waved to him from the train, crying out, “You must be Ethan!” as she jumped down with her bundles, while he reflected, looking over her slight person: “She don’t look much on housework, but she ain’t a fretter, anyhow.” But it was not only that the coming to his house of a bit of hopeful young life was like the lighting of a fire on a cold hearth. The girl was more than the bright serviceable creature he had thought her. She had an eye to see and an ear to hear: he could show her things and tell her things, and taste the bliss of feeling that all he imparted left long reverberations and echoes he could wake at will. It was during their night walks back to the farm that he felt most intensely the sweetness of this communion. He had always been more sensitive than the people about him to the appeal of natural beauty. His unfinished studies had given form to this sensibility and even in his unhappiest moments field and sky spoke to him with a deep and powerful persuasion. But hitherto the emotion had remained in him as a silent ache, veiling with sadness the beauty that evoked it. He did not even know whether any one else in the world felt as he did, or whether he was the sole victim of this mournful privilege. Then he learned that one other spirit had trembled with the same touch of wonder: that at his side, living under his roof and eating his bread, was a creature to whom he could say: That’s Orion down yonder; the big fellow to the right is Aldebaran, and the bunch of little ones—like bees swarming—they’re the Pleiades... or whom he could hold entranced before a ledge of granite thrusting up through the fern while he unrolled the huge panorama of the ice age, and the long dim stretches of succeeding time. The fact that admiration for his learning mingled with Mattie’s wonder at what he taught was not the least part of his pleasure. And there were other sensations, less definable but more exquisite, which drew them together with a shock of silent joy: the cold red of sunset behind winter hills, the flight of cloud-flocks over slopes of golden stubble, or the intensely blue shadows of hemlocks on sunlit snow. When she said to him once: “It looks just as if it was painted!” it seemed to Ethan that the art of definition could go no farther, and that words had at last been found to utter his secret soul....As he stood in the darkness outside the church these memories came back with the poignancy of vanished things. Watching Mattie whirl down the floor from hand to hand he wondered how he could ever have thought that his dull talk interested her. To him, who was never gay but in her presence, her gaiety seemed plain proof of indifference. The face she lifted to her dancers was the same which, when she saw him, always looked like a window that has caught the sunset. He even noticed two or three gestures which, in his fatuity, he had thought she kept for him: a way of throwing her head back when she was amused, as if to taste her laugh before she let it out, and a trick of sinking her lids slowly when anything charmed or moved her."
#test="The Moon, also known as Luna, is an astronomical body that orbits planet Earth and is Earth's only permanent natural satellite. It is the fifth-largest natural satellite in the Solar System, and the largest among planetary satellites relative to the size of the planet that it orbits (its primary). The Moon is after Jupiter's satellite Io the second-densest satellite in the Solar System among those whose densities are known. The Moon is thought to have formed about 4.51 billion years ago, not long after Earth. The most widely accepted explanation is that the Moon formed from the debris left over after a giant impact between Earth and a Mars-sized body called Theia.The Moon is in synchronous rotation with Earth, and thus always shows the same side to Earth, the near side. The near side is marked by dark volcanic maria that fill the spaces between the bright ancient crustal highlands and the prominent impact craters. After the Sun, the Moon is the second-brightest regularly visible celestial object in Earth's sky. Its surface is actually dark, although compared to the night sky it appears very bright, with a reflectance just slightly higher than that of worn asphalt. Its gravitational influence produces the ocean tides, body tides, and the slight lengthening of the day.The Moon's average orbital distance is 384,402 km (238,856 mi),[13][14] or 1.28 light-seconds. This is about thirty times the diameter of Earth. The Moon's apparent size in the sky is almost the same as that of the Sun, since the star is about 400 times the lunar distance and diameter. Therefore, the Moon covers the Sun nearly precisely during a total solar eclipse. This matching of apparent visual size will not continue in the far future because the Moon's distance from Earth is gradually increasing. The Moon was first reached in September 1959 by the Soviet Union's Luna 2, an unmanned spacecraft. The United States' NASA Apollo program achieved the only manned lunar missions to date, beginning with the first manned orbital mission by Apollo 8 in 1968, and six manned landings between 1969 and 1972, with the first being Apollo 11. These missions returned lunar rocks which have been used to develop a geological understanding of the Moon's origin, internal structure, and the Moon's later history. Since the Apollo 17 mission in 1972, the Moon has been visited only by unmanned spacecraft. Both the Moon's natural prominence in the earthly sky and its regular cycle of phases as seen from Earth have provided cultural references and influences for human societies and cultures since time immemorial. Such cultural influences can be found in language, lunar calendar systems, art, and mythology."
for part in msg.walk():
    if part.get_content_type() == 'application/msword':
        name = part.get_param('name') or 'MyDoc.doc'
        f = open(name, 'wb')
        f.write(part.get_payload(None, True)) # You need None as the first param
                                              # because part.is_multipart() 
                                              # is False
        f.close()

"""Now use the gensium code. Source: susanli2016 https://github.com/susanli2016/Machine-Learning-with-Python/blob/master/topic_modeling_Gensim.ipynb"""

import spacy
spacy.load('en')
from spacy.lang.en import English
parser = English()

def tokenize(text):
    lda_tokens = []
    tokens = parser(text)
    for token in tokens:
        if token.orth_.isspace():
            continue
        elif token.like_url:
            lda_tokens.append('URL')
        elif token.orth_.startswith('@'):
            lda_tokens.append('SCREEN_NAME')
        else:
            lda_tokens.append(token.lower_)
    return lda_tokens

import nltk
nltk.download('wordnet')
nltk.download('stopwords')
en_stop = set(nltk.corpus.stopwords.words('english'))

from nltk.corpus import wordnet as wn
def get_lemma(word):
    lemma = wn.morphy(word)
    if lemma is None:
        return word
    else:
        return lemma
      
import nltk
nltk.download('wordnet')

from nltk.stem.wordnet import WordNetLemmatizer
def get_lemma2(word):
    return WordNetLemmatizer().lemmatize(word)
  
nltk.download('stopwords')
en_stop = set(nltk.corpus.stopwords.words('english'))
    
from nltk.stem.wordnet import WordNetLemmatizer
def get_lemma2(word):
    return WordNetLemmatizer().lemmatize(word)

def prepare_text_for_lda(text):
    tokens = tokenize(text)
    tokens = [token for token in tokens if len(token) > 4]
    tokens = [token for token in tokens if token not in en_stop]
    tokens = [get_lemma(token) for token in tokens]
    return tokens
  
text_data=[]  
for word in test:
  tokens= prepare_text_for_lda(test)
  text_data.append(tokens)

"""Now to split the message data into topics. Lets start with 5 and see if a definite "food" one appears"""

from gensim import corpora
dictionary = corpora.Dictionary(text_data)

corpus = [dictionary.doc2bow(text) for text in text_data]

import pickle
pickle.dump(corpus, open('corpus.pkl', 'wb'))
dictionary.save('dictionary.gensim')

import gensim
NUM_TOPICS = 15
ldamodel = gensim.models.ldamodel.LdaModel(corpus, num_topics = NUM_TOPICS, id2word=dictionary, passes=15)
ldamodel.save('model5.gensim')

topics = ldamodel.print_topics(num_words=8)
for topic in topics:
    print(topic)
